<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>How to archive zero downtime deployments in Kubernetes | Cozi</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://cozi.dev/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css><link rel=stylesheet href=https://cozi.dev/scss/custom.min.b819f84c780cce1d59060b6144a7c87f62a4ea2d3bb1bfca48905f1a377efa20.css></head><body><nav><header><div class=site-title><a href=/><img id=logo src=https://cozi.dev/images/logo_light.svg title=Cozi alt=logo></a></div></header><div class="toc bot"><small>3 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><ul><li><a href=#define-readiness-probe>Define readiness probe</a></li><li><a href=#add-container-lifecycle-prestop-hook>Add container lifecycle preStop hook</a></li><li><a href=#listen-to-sigterm-signal>Listen to SIGTERM signal</a></li></ul></li><li><a href=#how-to-test>How to test?</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=nav-menu><a class="color-link nav-link" href=/about/>About</a>
<a class="color-link nav-link" href=/tags/>Tags</a>
<a class="color-link nav-link" href=/archives/>Archives</a>
<a class="color-link nav-link" href=https://cozi.dev/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> &<br><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></footer></nav><div id=content class=content-container><h1 class=post-title>How to archive zero downtime deployments in Kubernetes</h1><time>November 20, 2020</time><div class="toc top"><small>3 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><ul><li><a href=#define-readiness-probe>Define readiness probe</a></li><li><a href=#add-container-lifecycle-prestop-hook>Add container lifecycle preStop hook</a></li><li><a href=#listen-to-sigterm-signal>Listen to SIGTERM signal</a></li></ul></li><li><a href=#how-to-test>How to test?</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p><p>It was worse when you need to wait until late at night to deploy your app in production because you scare to break users&rsquo; experience when the short downtime happens after deployment.<br>You deserve a good sleep after a long working day, so let find out the solution for this.</p><p>For normal application, we just need to do 3 simple steps:</p><ul><li>Define readiness probe</li><li>Add container lifecycle preStop hook</li><li>Listen to SIGTERM signal</li></ul><h3 id=define-readiness-probe>Define readiness probe</h3><p>kubelet sends requests after your container running, but maybe your application is not ready to receive requests.
How to tell kubelet to wait until your application ready or stop sending requests if your application shutdown.
The answer is <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes target=_blank>readiness probe</a>, let view this example config for your deployment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#66d9ef>containers</span>:
  - <span style=color:#66d9ef>name</span>: my_web_app
    <span style=color:#66d9ef>readinessProbe</span>:
      <span style=color:#66d9ef>httpGet</span>:
        <span style=color:#66d9ef>path</span>: /health <span style=color:#75715e># your health check api</span>
        <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>8080</span> <span style=color:#75715e># your container port</span>
      <span style=color:#66d9ef>initialDelaySeconds</span>: <span style=color:#ae81ff>5</span> <span style=color:#75715e># delay 5s before send first request to check</span>
      <span style=color:#66d9ef>periodSeconds</span>: <span style=color:#ae81ff>2</span> <span style=color:#75715e># send check request every 2s</span>
      <span style=color:#66d9ef>successThreshold</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># success when the response has a status code greater than or equal to 200 and less than 400</span>
      <span style=color:#66d9ef>failureThreshold</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># otherwise failure</span>
...
</code></pre></div><h3 id=add-container-lifecycle-prestop-hook>Add container lifecycle preStop hook</h3><p>You should wait 15 seconds to let kubelet update routing to send requests to another pod.
By default, k8s wait 30 seconds before force killing your app, so you should use <code>preStop</code> hook with <code>terminationGracePeriodSeconds</code> options:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#66d9ef>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>60</span> <span style=color:#75715e># wait 60 seconds before force killing your app, increase it if you need more time</span>
<span style=color:#66d9ef>containers</span>:
  - <span style=color:#66d9ef>name</span>: my_web_app
    ...
    <span style=color:#66d9ef>lifecycle</span>:
      <span style=color:#66d9ef>preStop</span>:
        <span style=color:#66d9ef>exec</span>:
          <span style=color:#66d9ef>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 15&#34;</span>] <span style=color:#75715e># sleep 15 seconds before sending SIGTERM to container and let kubelet update routing</span>
...
</code></pre></div><h3 id=listen-to-sigterm-signal>Listen to SIGTERM signal</h3><p>Finally, listen to the SIGTERM signal to finish current requests, shutdown your app and close database connection, etc.
Here is a golang example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#a6e22e>quit</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>)
<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>quit</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>)

<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>quit</span> <span style=color:#75715e>// blocks util receive signal
</span><span style=color:#75715e>// finish current requests
</span><span style=color:#75715e>// close DB connection
</span><span style=color:#75715e>// shutdown app
</span></code></pre></div><h2 id=how-to-test>How to test?</h2><p>You can install HTTP testing tool like <a target=_blank href=https://github.com/tsenart/vegeta>vegeta</a>,
alongs with <a target=_blank href=https://github.com/stedolan/jq>jq</a> to format the report in the terminal</p><p>Example command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jq -ncM <span style=color:#e6db74>&#39;while(true; .+1) | {method: &#34;GET&#34;, url: &#34;http://localhost:30000?delay=5&#34;}&#39;</span> | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  vegeta attack -rate<span style=color:#f92672>=</span>200/s -lazy -format<span style=color:#f92672>=</span>json -duration<span style=color:#f92672>=</span>30s | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  tee results.bin | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  vegeta report
</code></pre></div><p>Then trigger force k8s update <code>my_web_app</code> deployment by this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl patch deployment my_web_app -p <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;{\&#34;spec\&#34;:{\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;date\&#34;:\&#34;`date +&#39;%s&#39;`\&#34;}}}}}&#34;</span>
</code></pre></div><p>You may got this report:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Requests      <span style=color:#f92672>[</span>total, rate, throughput<span style=color:#f92672>]</span>         3000, 100.03, 99.05
Duration      <span style=color:#f92672>[</span>total, attack, wait<span style=color:#f92672>]</span>             30.287s, 29.99s, 297.897ms
Latencies     <span style=color:#f92672>[</span>min, mean, 50, 90, 95, 99, max<span style=color:#f92672>]</span>  198.877ms, 363.615ms, 309.861ms, 381.551ms, 802.951ms, 1.988s, 2.692s
Bytes In      <span style=color:#f92672>[</span>total, mean<span style=color:#f92672>]</span>                     71244000, 23748.00
Bytes Out     <span style=color:#f92672>[</span>total, mean<span style=color:#f92672>]</span>                     0, 0.00
Success       <span style=color:#f92672>[</span>ratio<span style=color:#f92672>]</span>                           100.00%
Status Codes  <span style=color:#f92672>[</span>code:count<span style=color:#f92672>]</span>                      200:3000
Error Set:
</code></pre></div><h2 id=conclusions>Conclusions</h2><p>I hope you find something helpful to make your daily deployment task easier.</p><h2 id=references>References</h2><ul><li><a href=https://learnk8s.io/graceful-shutdown>https://learnk8s.io/graceful-shutdown</a></li></ul></p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"cozi-dev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/k8s>#k8s</a>
<a class=tag href=/tags/zero-downtime>#zero downtime</a>
<a class=tag href=/tags/graceful-shutdown>#graceful shutdown</a>
<a class=tag href=/tags/deployment>#deployment</a></div></div><footer class=footer-mobile><div class=social-icons></div><div class=footer-mobile-links><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></div><script src=https://cozi.dev/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin=anonymous></script><script async src="https://sdk.owids.com/js/app.js#id=bqnb4q1ba1fujo6isg10"></script></footer></body></html>