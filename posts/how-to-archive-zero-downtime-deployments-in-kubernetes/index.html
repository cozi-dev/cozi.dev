<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>How to archive zero downtime deployments in Kubernetes &#183; Cozi</title><meta name=description content><link rel=stylesheet href=/scss/main.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><script src=/js/main.min.js defer></script><meta property="og:title" content="How to archive zero downtime deployments in Kubernetes"><meta property="og:description" content="It was worse when you need to wait until late at night to deploy your app in production because you scare to break users&rsquo; experience when the short downtime happens after deployment."><meta property="og:type" content="article"><meta property="og:url" content="https://cozi.dev/posts/how-to-archive-zero-downtime-deployments-in-kubernetes/"><meta property="article:published_time" content="2020-11-20T05:21:53+07:00"><meta property="article:modified_time" content="2020-11-20T05:21:53+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to archive zero downtime deployments in Kubernetes"><meta name=twitter:description content="It was worse when you need to wait until late at night to deploy your app in production because you scare to break users&rsquo; experience when the short downtime happens after deployment."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><header class=site-header><div class=header-content><div class=nav-wrapper><div class=site-title><a href=https://cozi.dev/ class=logo-container><img class=logo src=https://cozi.dev/images/logo_light.svg title=Cozi alt=Cozi></a></div><nav class=main-nav><ul><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li><li><a href=/portfolio/>Portfolio</a></li><li><a href=/archives/>Archives</a></li><li><a href=/hire-me/>Hire me</a></li><li><button id=theme-toggle class=theme-toggle aria-label="Toggle dark mode"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button></li></ul></nav></div><button id=mobile-menu-toggle class=mobile-menu-toggle aria-label="Toggle menu" aria-expanded=false><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></header><div class=container><main class=main><div class=content><h1 class=post-title>How to archive zero downtime deployments in Kubernetes</h1><time>November 20, 2020</time><div class="toc top"><small>3 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><ul><li><a href=#define-readiness-probe>Define readiness probe</a></li><li><a href=#add-container-lifecycle-prestop-hook>Add container lifecycle preStop hook</a></li><li><a href=#listen-to-sigterm-signal>Listen to SIGTERM signal</a></li></ul></li><li><a href=#how-to-test>How to test?</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p><p>It was worse when you need to wait until late at night to deploy your app in production because you scare to break users&rsquo; experience when the short downtime happens after deployment.<br>You deserve a good sleep after a long working day, so let find out the solution for this.</p><p>For normal application, we just need to do 3 simple steps:</p><ul><li>Define readiness probe</li><li>Add container lifecycle preStop hook</li><li>Listen to SIGTERM signal</li></ul><h3 id=define-readiness-probe>Define readiness probe</h3><p>kubelet sends requests after your container running, but maybe your application is not ready to receive requests.
How to tell kubelet to wait until your application ready or stop sending requests if your application shutdown.
The answer is <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes target=_blank>readiness probe</a>, let view this example config for your deployment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#66d9ef>containers</span>:
  - <span style=color:#66d9ef>name</span>: my_web_app
    <span style=color:#66d9ef>readinessProbe</span>:
      <span style=color:#66d9ef>httpGet</span>:
        <span style=color:#66d9ef>path</span>: /health <span style=color:#75715e># your health check api</span>
        <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>8080</span> <span style=color:#75715e># your container port</span>
      <span style=color:#66d9ef>initialDelaySeconds</span>: <span style=color:#ae81ff>5</span> <span style=color:#75715e># delay 5s before send first request to check</span>
      <span style=color:#66d9ef>periodSeconds</span>: <span style=color:#ae81ff>2</span> <span style=color:#75715e># send check request every 2s</span>
      <span style=color:#66d9ef>successThreshold</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># success when the response has a status code greater than or equal to 200 and less than 400</span>
      <span style=color:#66d9ef>failureThreshold</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># otherwise failure</span>
...
</code></pre></div><h3 id=add-container-lifecycle-prestop-hook>Add container lifecycle preStop hook</h3><p>You should wait 15 seconds to let kubelet update routing to send requests to another pod.
By default, k8s wait 30 seconds before force killing your app, so you should use <code>preStop</code> hook with <code>terminationGracePeriodSeconds</code> options:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#66d9ef>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>60</span> <span style=color:#75715e># wait 60 seconds before force killing your app, increase it if you need more time</span>
<span style=color:#66d9ef>containers</span>:
  - <span style=color:#66d9ef>name</span>: my_web_app
    ...
    <span style=color:#66d9ef>lifecycle</span>:
      <span style=color:#66d9ef>preStop</span>:
        <span style=color:#66d9ef>exec</span>:
          <span style=color:#66d9ef>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 15&#34;</span>] <span style=color:#75715e># sleep 15 seconds before sending SIGTERM to container and let kubelet update routing</span>
...
</code></pre></div><h3 id=listen-to-sigterm-signal>Listen to SIGTERM signal</h3><p>Finally, listen to the SIGTERM signal to finish current requests, shutdown your app and close database connection, etc.
Here is a golang example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>...</span>
<span style=color:#a6e22e>quit</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>)
<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>quit</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>)

<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>quit</span> <span style=color:#75715e>// blocks util receive signal
</span><span style=color:#75715e>// finish current requests
</span><span style=color:#75715e>// close DB connection
</span><span style=color:#75715e>// shutdown app
</span></code></pre></div><h2 id=how-to-test>How to test?</h2><p>You can install HTTP testing tool like <a target=_blank href=https://github.com/tsenart/vegeta>vegeta</a>,
alongs with <a target=_blank href=https://github.com/stedolan/jq>jq</a> to format the report in the terminal</p><p>Example command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jq -ncM <span style=color:#e6db74>&#39;while(true; .+1) | {method: &#34;GET&#34;, url: &#34;http://localhost:30000?delay=5&#34;}&#39;</span> | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  vegeta attack -rate<span style=color:#f92672>=</span>200/s -lazy -format<span style=color:#f92672>=</span>json -duration<span style=color:#f92672>=</span>30s | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  tee results.bin | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  vegeta report
</code></pre></div><p>Then trigger force k8s update <code>my_web_app</code> deployment by this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl patch deployment my_web_app -p <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;{\&#34;spec\&#34;:{\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;date\&#34;:\&#34;`date +&#39;%s&#39;`\&#34;}}}}}&#34;</span>
</code></pre></div><p>You may got this report:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Requests      <span style=color:#f92672>[</span>total, rate, throughput<span style=color:#f92672>]</span>         3000, 100.03, 99.05
Duration      <span style=color:#f92672>[</span>total, attack, wait<span style=color:#f92672>]</span>             30.287s, 29.99s, 297.897ms
Latencies     <span style=color:#f92672>[</span>min, mean, 50, 90, 95, 99, max<span style=color:#f92672>]</span>  198.877ms, 363.615ms, 309.861ms, 381.551ms, 802.951ms, 1.988s, 2.692s
Bytes In      <span style=color:#f92672>[</span>total, mean<span style=color:#f92672>]</span>                     71244000, 23748.00
Bytes Out     <span style=color:#f92672>[</span>total, mean<span style=color:#f92672>]</span>                     0, 0.00
Success       <span style=color:#f92672>[</span>ratio<span style=color:#f92672>]</span>                           100.00%
Status Codes  <span style=color:#f92672>[</span>code:count<span style=color:#f92672>]</span>                      200:3000
Error Set:
</code></pre></div><h2 id=conclusions>Conclusions</h2><p>I hope you find something helpful to make your daily deployment task easier.</p><h2 id=references>References</h2><ul><li><a href=https://learnk8s.io/graceful-shutdown>https://learnk8s.io/graceful-shutdown</a></li></ul></p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"cozi-dev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/k8s>#k8s</a>
<a class=tag href=/tags/zero-downtime>#zero downtime</a>
<a class=tag href=/tags/graceful-shutdown>#graceful shutdown</a>
<a class=tag href=/tags/deployment>#deployment</a></div></div><aside class=sidebar><div class=sidebar-section><h2 class=sidebar-heading>About</h2><p>Cozi is a place where I share my software development journey, exploring programming languages, frameworks, design patterns, and more.</p></div><div class=sidebar-section><h2 class=sidebar-heading>Recent Posts</h2><div class=recent-posts><div class=recent-post><a href=/posts/serving-aws-s3-private-content-with-golang-and-aws-sdk-for-go-v2/>Serving AWS S3 private content with Golang and AWS SDK for Go v2</a>
<span class=recent-post-date>Feb 5, 2024</span></div><div class=recent-post><a href=/posts/setting-up-a-virtual-environment-with-vagrant-for-testing/>Setting up a virtual environment with Vagrant for testing</a>
<span class=recent-post-date>Oct 11, 2023</span></div><div class=recent-post><a href=/posts/golang-create-combinations-from-n-arrays/>Golang Create Combinations From N Arrays</a>
<span class=recent-post-date>Sep 24, 2022</span></div><div class=recent-post><a href=/posts/mongodb-query-get-n-records-of-each-group-aggregation/>MongoDB query get n records of each group (aggregation)</a>
<span class=recent-post-date>Jul 4, 2022</span></div><div class=recent-post><a href=/posts/transfer-files-to-new-server-using-ansible/>Transfer files to new server using Ansible</a>
<span class=recent-post-date>Jun 24, 2022</span></div></div></div><div class=sidebar-section><h2 class=sidebar-heading>Tags</h2><div class=tags><a href=/tags/announcement class=tag>announcement (1)</a>
<a href=/tags/ansible class=tag>ansible (3)</a>
<a href=/tags/api class=tag>api (1)</a>
<a href=/tags/application class=tag>application (1)</a>
<a href=/tags/aws class=tag>aws (1)</a>
<a href=/tags/channels class=tag>channels (1)</a>
<a href=/tags/chat class=tag>chat (1)</a>
<a href=/tags/ci/cd class=tag>ci/cd (1)</a>
<a href=/tags/cicd class=tag>cicd (1)</a>
<a href=/tags/cli class=tag>cli (1)</a>
<a href=/tags/combination class=tag>combination (1)</a>
<a href=/tags/command class=tag>command (1)</a>
<a href=/tags/component class=tag>component (1)</a>
<a href=/tags/css class=tag>css (3)</a>
<a href=/tags/darkmode class=tag>darkmode (1)</a>
<a href=/tags/database class=tag>database (2)</a>
<a href=/tags/debug class=tag>debug (1)</a>
<a href=/tags/deployment class=tag>deployment (1)</a>
<a href=/tags/devops class=tag>devops (2)</a>
<a href=/tags/disk class=tag>disk (1)</a>
<a href=/tags/django class=tag>django (1)</a>
<a href=/tags/docker class=tag>docker (2)</a>
<a href=/tags/driver class=tag>driver (1)</a>
<a href=/tags/drone class=tag>drone (1)</a>
<a href=/tags/echo class=tag>echo (2)</a>
<a href=/tags/framework class=tag>framework (1)</a>
<a href=/tags/git class=tag>git (1)</a>
<a href=/tags/gitlab class=tag>gitlab (1)</a>
<a href=/tags/go class=tag>go (8)</a>
<a href=/tags/go-micro class=tag>go-micro (1)</a>
<a href=/tags/golang class=tag>golang (1)</a>
<a href=/tags/graceful-shutdown class=tag>graceful-shutdown (1)</a>
<a href=/tags/html class=tag>html (1)</a>
<a href=/tags/ide class=tag>ide (1)</a>
<a href=/tags/iframe class=tag>iframe (1)</a>
<a href=/tags/informercat class=tag>informercat (1)</a>
<a href=/tags/insomnia class=tag>insomnia (1)</a>
<a href=/tags/javascript class=tag>javascript (1)</a>
<a href=/tags/json class=tag>json (1)</a>
<a href=/tags/k8s class=tag>k8s (1)</a>
<a href=/tags/launch class=tag>launch (2)</a>
<a href=/tags/life class=tag>life (1)</a>
<a href=/tags/macbook class=tag>macbook (1)</a>
<a href=/tags/macos class=tag>macos (1)</a>
<a href=/tags/microservices class=tag>microservices (1)</a>
<a href=/tags/mongo class=tag>mongo (1)</a>
<a href=/tags/mongodb class=tag>mongodb (2)</a>
<a href=/tags/nosql class=tag>nosql (1)</a>
<a href=/tags/online class=tag>online (1)</a>
<a href=/tags/pre-processors class=tag>pre-processors (1)</a>
<a href=/tags/query class=tag>query (1)</a>
<a href=/tags/review class=tag>review (1)</a>
<a href=/tags/s3 class=tag>s3 (1)</a>
<a href=/tags/server class=tag>server (1)</a>
<a href=/tags/ssh class=tag>ssh (1)</a>
<a href=/tags/supics class=tag>supics (1)</a>
<a href=/tags/tailwind class=tag>tailwind (1)</a>
<a href=/tags/test class=tag>test (2)</a>
<a href=/tags/tips class=tag>tips (1)</a>
<a href=/tags/tool class=tag>tool (3)</a>
<a href=/tags/vagrant class=tag>vagrant (1)</a>
<a href=/tags/vim class=tag>vim (1)</a>
<a href=/tags/virtualbox class=tag>virtualbox (1)</a>
<a href=/tags/vm class=tag>vm (1)</a>
<a href=/tags/vscode class=tag>vscode (1)</a>
<a href=/tags/vue class=tag>vue (6)</a>
<a href=/tags/vue-cli class=tag>vue-cli (1)</a>
<a href=/tags/webpack class=tag>webpack (2)</a>
<a href=/tags/websocket class=tag>websocket (2)</a>
<a href=/tags/zero-downtime class=tag>zero-downtime (1)</a></div></div></aside></main><footer class=site-footer><div>&copy; 2025 Cozi</div><div>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></div></footer></div><span class=article-tags><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a href=/tags/k8s>k8s</a>
<a href=/tags/zero-downtime>zero downtime</a>
<a href=/tags/graceful-shutdown>graceful shutdown</a>
<a href=/tags/deployment>deployment</a></span>
<script async src="https://sdk.owids.com/js/app.js#id=bqnb4q1ba1fujo6isg10"></script></body></html>