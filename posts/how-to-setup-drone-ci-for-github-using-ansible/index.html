<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>How to set up Drone CI for GitHub using Ansible | Cozi</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#111827"><link rel=stylesheet href=https://cozi.dev/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css><link rel=stylesheet href=https://cozi.dev/scss/custom.min.24f13638c8c36989477ed31aa55814ee1ad189e3f347bb467053c3a31aff4eeb.css></head><body><nav><header><div class=site-title><a href=/><img id=logo src=https://cozi.dev/images/logo_light.svg title=Cozi alt=logo></a></div></header><div class="toc bot"><small>2 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#ansible-playbook>Ansible playbook</a><ul><li><a href=#structure>Structure</a></li><li><a href=#source-code>Source code</a></li><li><a href=#run-playbook-to-install-drone>Run playbook to install Drone</a></li></ul></li><li><a href=#tips>Tips</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=nav-menu><a class="color-link nav-link" href=/about/>About</a>
<a class="color-link nav-link" href=/tags/>Tags</a>
<a class="color-link nav-link" href=/archives/>Archives</a>
<a class="color-link nav-link" href=/portfolio/>Portfolio</a>
<a class="color-link nav-link" href=https://cozi.dev/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> &<br><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></footer></nav><div id=content class=content-container><h1 class=post-title>How to set up Drone CI for GitHub using Ansible</h1><time>May 1, 2020</time><div class="toc top"><small>2 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#ansible-playbook>Ansible playbook</a><ul><li><a href=#structure>Structure</a></li><li><a href=#source-code>Source code</a></li><li><a href=#run-playbook-to-install-drone>Run playbook to install Drone</a></li></ul></li><li><a href=#tips>Tips</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p><h2 id=introduction>Introduction</h2><p>This tutorial will show you how to set up <a href=https://drone.io/>Drone CI</a> for GitHub using Ansible. I&rsquo;ve used Jenkins for a few years but now I&rsquo;m looking for a better and simple CI/CD platform. I tried several tools like Github Actions, Bitbucket Pipelines, Travis CI but the suitable tool for me is Drone with those advantages:</p><div class=ticks><ul><li>Lightweight</li><li>Open source</li><li>Configuration as Code</li><li>Provide all plugins you need</li><li>Seamlessly integrates with popular source code management systems</li><li>Local execution</li></ul></div><p>But when I first started I found that the Drone installation document is hard for me. So, I will share my steps here if it could help someone else like me ðŸ˜…</p><p><strong>Note:</strong> Although, GitHub is using for this article but you can use Drone with your favorite source code management system too.</p><h2 id=prerequisites>Prerequisites</h2><p>You need to install Ansible by following <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html>this installation guide</a> and has a basic understanding of Ansible.</p><p><strong>Prepare a GitHub OAuth application:</strong></p><p>Create a GitHub OAuth application by follow this address <a href=https://github.com/settings/applications/new>https://github.com/settings/applications/new</a>.</p><img class=article-image src=/posts/how-to-setup-drone-ci-for-github-using-ansible/new_oauth_application.jpg alt><p>The Client ID and Client Secret are used to authorize access to GitHub resources.</p><img class=article-image src=/posts/how-to-setup-drone-ci-for-github-using-ansible/oauth_application_settings.jpg alt><h2 id=ansible-playbook>Ansible playbook</h2><h3 id=structure>Structure</h3><div class=file-tree><ul><li>inventories<ul><li>host.yml</li></ul></li><li>roles<ul><li>drone<ul><li>handlers<ul><li>main.yml</li></ul></li><li>tasks<ul><li>cert.yml</li><li>main.yml</li><li>nginx.yml</li><li>provision.yml</li><li>start_drone.yml</li></ul></li><li>templates<ul><li>nginx.j2</li><li>agent.env.j2</li><li>server.env.j2</li></ul></li></ul></li></ul></li><li>drone.yml</li></ul></div><h3 id=source-code>Source code</h3><p><a href=https://github.com/cozi-dev/drone-ansible>https://github.com/cozi-dev/drone-ansible</a></p><p>Clone it to your machine and update those file&rsquo;s variables with your own configurations:</p><h4 id=inventorieshostyml>inventories/host.yml</h4><ul><li><strong>{{ YOUR_SERVER_IP_ADDRESS }}</strong>: Server IP address</li></ul><h4 id=droneyml>drone.yml</h4><ul><li><strong>{{ YOUR_DOMAIN }}</strong>: Drone domain address.</li><li><strong>{{ YOUR_EMAIL }}</strong>: Let&rsquo;s Encrypt registration email address.</li><li><strong>{{ YOUR_DRONE_RPC_SECRET }}</strong>: Authenticate the RPC connection to the Drone server.</li><li><strong>{{ YOUR_DRONE_ADMIN_USER }}</strong>: Drone admin user.</li><li><strong>{{ YOUR_DRONE_GITHUB_CLIENT_ID }}</strong>: GitHub client id.</li><li><strong>{{ YOUR_DRONE_GITHUB_CLIENT_SECRET }}</strong>: GitHub client secret.</li></ul><h3 id=run-playbook-to-install-drone>Run playbook to install Drone</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ansible-playbook drone.yml -i ./inventories/host.yaml
</code></pre></div><p>After this step, you can go to your domain address to access Drone dashboard:</p><figure class=article-figure><img class=article-image src=/posts/how-to-setup-drone-ci-for-github-using-ansible/drone_ci_dashboard.jpg alt><figcaption><small><i>Drone dashboard - simple and fast.</i></small></figcaption></figure><h2 id=tips>Tips</h2><p>You can config Drone CLI to manage secret variables by following this <a href=https://docs.drone.io/cli/configure/>link</a>.</p><p>Grab your API Token from <strong>User settings</strong>:</p><figure class=article-figure><img class=article-image src=/posts/how-to-setup-drone-ci-for-github-using-ansible/account_drone_ci.jpg alt><figcaption><small><i>User settings.</i></small></figcaption></figure><p><strong>For example:</strong></p><p>Add secret deploy ssh key by following command:</p><pre class="code-annotated numbered">
drone orgsecret add <span class=highlight>cozi-dev</span> <span class=highlight>deploy_ssh_private_key</span> <span class=highlight>@/home/cozi/.ssh/id_rsa</span>
</pre><ol><li>GitHub username or organization name.</li><li>Secret variable name.</li><li>Secret variable value.</li></ol><p>For more details, please check <a href=https://docs.drone.io/secret/organization/>this documentation</a>.</p><h2 id=conclusion>Conclusion</h2><p>Drone is a great CI/CD platform that I enjoy using it so much. The configuration is on the code, so I don&rsquo;t need to manage it elsewhere. Build status can be monitored with a simple Slack plugin.</p><h2 id=references>References</h2><ol><li><a href=https://docs.drone.io/server/provider/github/>https://docs.drone.io/server/provider/github/</a></li><li><a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html>https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html</a></li></ol></p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"cozi-dev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/drone>#drone</a>
<a class=tag href=/tags/ci/cd>#ci/cd</a>
<a class=tag href=/tags/ansible>#ansible</a></div></div><footer class=footer-mobile><div class=social-icons></div><div class=footer-mobile-links><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></div><script src=https://cozi.dev/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin=anonymous></script><script async src="https://sdk.owids.com/js/app.js#id=bqnb4q1ba1fujo6isg10"></script></footer></body></html>