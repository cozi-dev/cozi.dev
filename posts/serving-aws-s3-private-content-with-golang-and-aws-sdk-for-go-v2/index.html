<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Serving AWS S3 private content with Golang and AWS SDK for Go v2 | Cozi</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#111827"><link rel=stylesheet href=https://cozi.dev/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css><link rel=stylesheet href=https://cozi.dev/scss/custom.min.f3193f4379c959aff6882e30608bcfefba5471f4f3cc8b192fce13c2be40e788.css></head><body><nav><header><div class=site-title><a href=/><img id=logo src=https://cozi.dev/images/logo_light.svg title=Cozi alt=logo></a></div></header><div class="toc bot"><small>6 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#steps>Steps</a><ul><li><a href=#1-creating-the-aws-s3-client>1. Creating the AWS S3 client</a></li><li><a href=#2-creating-http-handler-to-serve-private-content-using-presigned-url>2. Creating HTTP handler to serve private content using presigned URL</a></li><li><a href=#3-running-the-http-server>3. Running the HTTP Server</a></li></ul></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=nav-menu><a class="color-link nav-link" href=/about/>About</a>
<a class="color-link nav-link" href=/tags/>Tags</a>
<a class="color-link nav-link" href=/archives/>Archives</a>
<a class="color-link nav-link" href=/portfolio/>Portfolio</a>
<a class="color-link nav-link" href=/hire-me/>Hire me</a>
<a class="color-link nav-link" href=https://cozi.dev/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> &<br><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></footer></nav><div id=content class=content-container><h1 class=post-title>Serving AWS S3 private content with Golang and AWS SDK for Go v2</h1><time>February 5, 2024</time><div class="toc top"><small>6 mins read</small><h6 class=toc-label>What's on this page</h6><div class=toc-body><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#steps>Steps</a><ul><li><a href=#1-creating-the-aws-s3-client>1. Creating the AWS S3 client</a></li><li><a href=#2-creating-http-handler-to-serve-private-content-using-presigned-url>2. Creating HTTP handler to serve private content using presigned URL</a></li><li><a href=#3-running-the-http-server>3. Running the HTTP Server</a></li></ul></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=post-content><p><p>Have you ever wanted to serve private files from your AWS S3 storage to your users, but making the bucket public is not a safe option? In this post, I will show you how to do it using Golang and AWS SDK for Go v2 with a presigned URL, and later, you can integrate it with your own authentication system. Let&rsquo;s dive in!</p><h2 id=prerequisites>Prerequisites</h2><ul><li>Go 1.19 or later</li><li>AWS SDK for Go v2</li><li>Private S3 bucket and credentials to access it (atleast <code>s3:GetObject</code> permission)</li></ul><h2 id=steps>Steps</h2><h3 id=1-creating-the-aws-s3-client>1. Creating the AWS S3 client</h3><p>There are two options for creating the AWS S3 client:</p><p><strong>a. Using access key and secret key (not recommended for production)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newS3Client</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Options</span>{
        <span style=color:#a6e22e>BaseEndpoint</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;your_s3_endpoint&#34;</span>), <span style=color:#75715e>// Replace with your S3 endpoint
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>Region</span>: <span style=color:#e6db74>&#34;your_s3_region&#34;</span>, <span style=color:#75715e>// Replace with your S3 region
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>Credentials</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>NewCredentialsCache</span>(
            <span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>NewStaticCredentialsProvider</span>(
                <span style=color:#e6db74>&#34;your_access_key&#34;</span>, <span style=color:#75715e>// Replace with your AWS access key
</span><span style=color:#75715e></span>                <span style=color:#e6db74>&#34;your_secret_key&#34;</span>, <span style=color:#75715e>// Replace with your AWS secret key
</span><span style=color:#75715e></span>                <span style=color:#e6db74>&#34;&#34;</span>,
            ),
        ),
    })
}
</code></pre></div><p><strong>b. Using IAM role for service account credentials</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newS3Client</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span> {
    <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(),
        <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>WithRegion</span>(<span style=color:#e6db74>&#34;your_s3_region&#34;</span>), <span style=color:#75715e>// Replace with your S3 region
</span><span style=color:#75715e></span>    )
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        panic(<span style=color:#a6e22e>err</span>)
    }

    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
}
</code></pre></div><h3 id=2-creating-http-handler-to-serve-private-content-using-presigned-url>2. Creating HTTP handler to serve private content using presigned URL</h3><p>Creating HTTP handler that will handle incoming requests and generate the signed URLs for private S3 content.
This function serves well for both partial content and full content.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>s3Handler</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>s3Client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newS3Handler</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3Handler</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3Handler</span>{
		<span style=color:#a6e22e>s3Client</span>: <span style=color:#a6e22e>newS3Client</span>(),
	}
}

<span style=color:#75715e>// The servingContent function is the HTTP handler that takes a request, extracts the bucket name, object path from the parameters, 
</span><span style=color:#75715e>// generates a signed URL for the private S3 object, and then response file content to client.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3Handler</span>) <span style=color:#a6e22e>servingContent</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimLeft</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
	<span style=color:#a6e22e>bucketName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#ae81ff>0</span>]
	<span style=color:#a6e22e>path</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>bucketName</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>1</span>)

    <span style=color:#75715e>// generate presigned URL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewPresignClient</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>s3Client</span>)
	<span style=color:#a6e22e>presignedGetRequest</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>presignClient</span>.<span style=color:#a6e22e>PresignGetObject</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>GetObjectInput</span>{
		<span style=color:#a6e22e>Bucket</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>bucketName</span>),
		<span style=color:#a6e22e>Key</span>:    <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>path</span>),
		<span style=color:#a6e22e>Range</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Range&#34;</span>)),
	})
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to presign request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// new http reqest
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#a6e22e>presignedGetRequest</span>.<span style=color:#a6e22e>URL</span>, <span style=color:#66d9ef>nil</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to create request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// set request headers
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span> {
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
			<span style=color:#75715e>// ignore header: If-Modified-Since, If-None-Match to prevent status 304
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;If-Modified-Since&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;If-None-Match&#34;</span> {
				<span style=color:#66d9ef>continue</span>
			}

			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
		}
	}
	<span style=color:#75715e>// set header no cache to prevent status 304
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Cache-Control&#34;</span>, <span style=color:#e6db74>&#34;no-cache&#34;</span>)
	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Pragma&#34;</span>, <span style=color:#e6db74>&#34;no-cache&#34;</span>)

	<span style=color:#a6e22e>httpClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{}
	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httpClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to get response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#75715e>// check status code
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> &lt; <span style=color:#ae81ff>200</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> &gt; <span style=color:#ae81ff>299</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to get response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// set response headers
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span> {
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
		}
	}

	<span style=color:#75715e>// check if the response contains partial content
</span><span style=color:#75715e></span>    <span style=color:#75715e>// for streaming content like video, audio, etc.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Content-Range&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Length&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>ContentLength</span>))
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/octet-stream&#34;</span>)
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusPartialContent</span>)
	}

	<span style=color:#75715e>// write response body to client
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
}
</code></pre></div><h3 id=3-running-the-http-server>3. Running the HTTP Server</h3><p>Finally, we need to start the HTTP server and register the handler.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// register the handler
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s3Handler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newS3Handler</span>()
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>s3Handler</span>.<span style=color:#a6e22e>servingContent</span>)

    <span style=color:#75715e>// start the server
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;:8080&#34;</span>
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Server start at&#34;</span>, <span style=color:#a6e22e>port</span>)
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>port</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><h2 id=putting-it-all-together>Putting it all together</h2><p>Here is the complete code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;io&#34;</span>
	<span style=color:#e6db74>&#34;log&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>
	<span style=color:#e6db74>&#34;strings&#34;</span>

	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/credentials&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/s3&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#75715e>// register the handler
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s3Handler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newS3Handler</span>()
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>s3Handler</span>.<span style=color:#a6e22e>servingContent</span>)

	<span style=color:#75715e>// start the server
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;:8080&#34;</span>
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Server start at&#34;</span>, <span style=color:#a6e22e>port</span>)
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>port</span>, <span style=color:#66d9ef>nil</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newS3Client</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Options</span>{
		<span style=color:#a6e22e>BaseEndpoint</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;your_s3_endpoint&#34;</span>), <span style=color:#75715e>// Replace with your S3 endpoint
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>Region</span>:       <span style=color:#e6db74>&#34;your_s3_region&#34;</span>,               <span style=color:#75715e>// Replace with your S3 region
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>Credentials</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>NewCredentialsCache</span>(
			<span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>NewStaticCredentialsProvider</span>(
				<span style=color:#e6db74>&#34;your_access_key&#34;</span>, <span style=color:#75715e>// Replace with your AWS access key
</span><span style=color:#75715e></span>				<span style=color:#e6db74>&#34;your_secret_key&#34;</span>, <span style=color:#75715e>// Replace with your AWS secret key
</span><span style=color:#75715e></span>				<span style=color:#e6db74>&#34;&#34;</span>,
			),
		),
	})
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>s3Handler</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>s3Client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newS3Handler</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3Handler</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3Handler</span>{
		<span style=color:#a6e22e>s3Client</span>: <span style=color:#a6e22e>newS3Client</span>(),
	}
}

<span style=color:#75715e>// The servingContent function is the HTTP handler that takes a request, extracts the bucket name, object path from the parameters,
</span><span style=color:#75715e>// generates a signed URL for the private S3 object, and then response file content to client.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3Handler</span>) <span style=color:#a6e22e>servingContent</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimLeft</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
	<span style=color:#a6e22e>bucketName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#ae81ff>0</span>]
	<span style=color:#a6e22e>path</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>bucketName</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>1</span>)

	<span style=color:#75715e>// generate presigned URL
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewPresignClient</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>s3Client</span>)
	<span style=color:#a6e22e>presignedGetRequest</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>presignClient</span>.<span style=color:#a6e22e>PresignGetObject</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>GetObjectInput</span>{
		<span style=color:#a6e22e>Bucket</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>bucketName</span>),
		<span style=color:#a6e22e>Key</span>:    <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>path</span>),
		<span style=color:#a6e22e>Range</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Range&#34;</span>)),
	})
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to presign request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// new http reqest
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#a6e22e>presignedGetRequest</span>.<span style=color:#a6e22e>URL</span>, <span style=color:#66d9ef>nil</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to create request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// set request headers
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span> {
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
			<span style=color:#75715e>// ignore header: If-Modified-Since, If-None-Match to prevent status 304
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;If-Modified-Since&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;If-None-Match&#34;</span> {
				<span style=color:#66d9ef>continue</span>
			}

			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
		}
	}
	<span style=color:#75715e>// set header no cache to prevent status 304
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Cache-Control&#34;</span>, <span style=color:#e6db74>&#34;no-cache&#34;</span>)
	<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Pragma&#34;</span>, <span style=color:#e6db74>&#34;no-cache&#34;</span>)

	<span style=color:#a6e22e>httpClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{}
	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httpClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to get response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#75715e>// check status code
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> &lt; <span style=color:#ae81ff>200</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span> &gt; <span style=color:#ae81ff>299</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to get response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusText</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// set response headers
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span> {
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
		}
	}

	<span style=color:#75715e>// check if the response contains partial content
</span><span style=color:#75715e></span>	<span style=color:#75715e>// for streaming content like video, audio, etc.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Content-Range&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Length&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>ContentLength</span>))
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/octet-stream&#34;</span>)
		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusPartialContent</span>)
	}

	<span style=color:#75715e>// write response body to client
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
}
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>In this post, we have learned how to serve private content from AWS S3 using Golang and AWS SDK for Go v2. We have created an HTTP handler that generates a presigned URL for the private S3 object and then serves the file content to the client. This approach is secure and efficient, and it allows you to serve private content from your S3 storage to your users without making the bucket public.</p><p>Furthermore, you can modify the <code>servingContent</code> function to fit your needs, such as adding authentication, authorization, or caching. For example, you can add authentication middleware to ensure that only authorized users can access the private content.</p><p>I hope you find this post helpful. Please let me know in the comment section below if you have any questions.</p></p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"cozi-dev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/go>#go</a>
<a class=tag href=/tags/aws>#aws</a>
<a class=tag href=/tags/s3>#s3</a></div></div><footer class=footer-mobile><div class=social-icons></div><div class=footer-mobile-links><p class=credits>Built with <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy</a></p></div><script src=https://cozi.dev/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin=anonymous></script><script async src="https://sdk.owids.com/js/app.js#id=bqnb4q1ba1fujo6isg10"></script></footer></body></html>